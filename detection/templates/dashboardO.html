{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Graphiques Dynamiques de Sécurité</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'css/dashBO.css' %}">
</head>
<body>
    <div class="container">
        <h1>Graphiques Dynamiques de Sécurité</h1>

        <!-- Boutons de Redirection -->
        <div class="buttons">
            <button onclick="location.href='{% url 'tableO' %}'">Table Ossec</button>
            <button onclick="location.href='{% url 'dashboardS' %}'">Dashboard snort</button>
        </div>
        

        <!-- Filtres -->
        <div class="filters">
            <label for="startDate">Date de début:</label>
            <input type="date" id="startDate">
            <label for="endDate">Date de fin:</label>
            <input type="date" id="endDate">
            <button onclick="applyFilters()">Appliquer les filtres</button>
        </div>

        <!-- Graphique 1: Évolution des événements dans le temps -->
        <div class="chart-container">
            <h2>Évolution des événements dans le temps</h2>
            <canvas id="eventEvolutionChart" width="600" height="400"></canvas>
            <button onclick="exportToImage('eventEvolutionChart')">Exporter en Image</button>
        </div>

        <!-- Graphique 2: Distribution des niveaux de règle -->
        <div class="chart-container">
            <h2>Distribution des niveaux de règle</h2>
            <canvas id="ruleLevelDistributionChart" width="600" height="400"></canvas>
            <button onclick="exportToImage('ruleLevelDistributionChart')">Exporter en Image</button>
        </div>

        <!-- Graphique 3: Analyse des prédictions ML -->
        <div class="chart-container">
            <h2>Analyse des prédictions ML</h2>
            <canvas id="mlPredictionChart" width="600" height="400"></canvas>
            <div id="mlPredictionLegend" class="legend"></div>
            <button onclick="exportToImage('mlPredictionChart')">Exporter en Image</button>
        </div>
        
    </div>

    <footer>
        &copy; 2024 Votre Compagnie - Tous droits réservés.
    </footer>

    <script>
        fetch('/graphe_data/')
            .then(response => response.json())
            .then(data => {
                console.log(data);  // Vérifier les données
                const timestamps = data.map(item => new Date(item.timestamp).toLocaleString());
                const firedTimes = data.map(item => item.rule_firedtimes);
                const ruleLevels = data.map(item => item.rule_level);
                const predictions = data.map(item => item.prediction_ml);
                const ruleGroups = data.map(item => item.rule_groups);

                console.log("Rule Levels:", ruleLevels);  // Vérifier les niveaux de règle
                console.log("Predictions:", predictions);  // Vérifier les prédictions

                // Graphique 1: Évolution des événements dans le temps
                var ctx1 = document.getElementById('eventEvolutionChart').getContext('2d');
                var eventEvolutionChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: timestamps,
                        datasets: [{
                            label: 'Fired Times',
                            data: firedTimes,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            tooltip: {
                                enabled: true
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#333'
                                }
                            }
                        }
                    }
                });

                // Graphique 2: Distribution des niveaux de règle
                const uniqueRuleLevels = Array.from(new Set(ruleLevels)).sort((a, b) => a - b);
                const ruleLevelCounts = uniqueRuleLevels.map(level => ruleLevels.filter(l => l === level).length);

                var ctx2 = document.getElementById('ruleLevelDistributionChart').getContext('2d');
                var ruleLevelDistributionChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: uniqueRuleLevels,
                        datasets: [{
                            label: 'Rule Levels',
                            data: ruleLevelCounts,
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Niveau de Règle'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Nombre d\'Occurrences'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                enabled: true
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#333'
                                }
                            }
                        }
                    }
                });

                // Graphique 3: Analyse des prédictions ML
                var ctx3 = document.getElementById('mlPredictionChart').getContext('2d');
                var uniquePredictions = Array.from(new Set(predictions));
                if (uniquePredictions.length > 0) {
                    var mlPredictionChart = new Chart(ctx3, {
                        type: 'pie',
                        data: {
                            labels: uniquePredictions,
                            datasets: [{
                                label: 'ML Predictions',
                                data: uniquePredictions.map(pred => predictions.filter(p => p === pred).length),
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.2)',
                                    'rgba(54, 162, 235, 0.2)',
                                    'rgba(255, 206, 86, 0.2)',
                                    'rgba(75, 192, 192, 0.2)',
                                    'rgba(153, 102, 255, 0.2)',
                                    'rgba(255, 159, 64, 0.2)'
                                ],
                                borderColor: [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(153, 102, 255, 1)',
                                    'rgba(255, 159, 64, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                tooltip: {
                                    enabled: true
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        color: '#333'
                                    }
                                }
                            }
                        }
                    });

                    // Ajouter la légende détaillée pour le troisième graphique
                    var mlPredictionLegend = document.getElementById('mlPredictionLegend');
                    var colors = [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ];
                    var legendHtml = '<ul>';
                    uniquePredictions.forEach((pred, index) => {
                        legendHtml += `<li><span style="background-color:${colors[index]};"></span>${pred}</li>`;
                    });
                    legendHtml += '</ul>';
                    mlPredictionLegend.innerHTML = legendHtml;
                } else {
                    console.log("No predictions data available.");
                }
            });

        // Fonction pour appliquer les filtres de date
        function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            // Recharger les graphiques avec les nouvelles dates
            fetch(`/graphe_data/?start=${startDate}&end=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    // Mettre à jour les graphiques avec les nouvelles données
                });
        }

        // Fonction d'exportation en image
        function exportToImage(chartId) {
            const canvas = document.getElementById(chartId);
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = chartId + '.png';
            link.click();
        }
    </script>
</body>
</html>
